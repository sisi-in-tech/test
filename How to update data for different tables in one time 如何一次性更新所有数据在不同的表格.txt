ALTER PROCEDURE P_UPD_NULL_VALUES
AS
BEGIN

--返回不计数

SET NOCOUNT ON

---DECLARE UPDATE VARIABLE STATEMMENT ,  变量表格， 当表格中包含columns的时候，进行更新

DECLARE @SQL VARCHAR(MAX),
	@TBL VARCHAR(200),
	@YN_DIVISION_NAME CHAR(1),
	@YN_DIVISION_NUMBER CHAR(1),
	@YN_REGION_NAME CHAR(1),
	@YN_REGION_NUMBER CHAR(1),
	@YN_STATE_CODE CHAR(1),
	@YN_STATE_NAME CHAR(1)

---DECLARE CURSOR FOR NOT_NULL_COLUMNS 表格，条件找到是null的列， 并且含有column STATE_NUMBER 

DECLARE C1 CURSOR FOR
SELECT TABLE_NAME,
  YN_DIVISION_NAME = MAX(CASE WHEN COLUMN_NAME = 'DIVISION_NAME' THEN 'Y' ELSE 'N' END),
  YN_DIVISION_NUMBER = MAX(CASE WHEN COLUMN_NAME = 'DIVISION_NUMBER' THEN 'Y' ELSE 'N' END),
  YN_REGION_NAME = MAX(CASE WHEN COLUMN_NAME = 'REGION_NAME' THEN 'Y' ELSE 'N' END),
  YN_REGION_NUMBER = MAX(CASE WHEN COLUMN_NAME = 'REGION_NUMBER' THEN 'Y' ELSE 'N' END),
  YN_STATE_CODE = MAX(CASE WHEN COLUMN_NAME = 'STATE_CODE' THEN 'Y' ELSE 'N' END),
  YN_STATE_NAME = MAX(CASE WHEN COLUMN_NAME = 'STATE_NAME' THEN 'Y' ELSE 'N' END)

FROM DBA_NULL_COLUMNS A
WHERE CNT_COLUMN_IN_RECORDS > 0 AND 
      CNT_COLUMN_NON_NULL = 0 AND
      COLUMN_NAME IN ('DIVISION_NAME', 'DIVISION_NUMBER', 'REGION_NAME', 'REGION_NUMBER', 
					  'STATE_CODE', 'STATE_NAME') AND
	  EXISTS 
	    (SELECT * 
		 FROM DBA_NULL_COLUMNS B
		 WHERE B.TABLE_NAME = A.TABLE_NAME AND 
		       B.COLUMN_NAME = 'STATE_NUMBER')
GROUP BY TABLE_NAME
---打开CURSOR 

OPEN C1
FETCH C1 INTO @TBL, @YN_DIVISION_NAME, @YN_DIVISION_NUMBER, @YN_REGION_NAME,
		@YN_REGION_NUMBER, @YN_STATE_CODE, @YN_STATE_NAME 

-- 当 CURSOR条件成立的时候， 开始

WHILE @@FETCH_STATUS = 0
BEGIN

-- 运行@SQL UPDATE from DIM_GEORAPHY_STATE (ELSE 的后面应该跟值，但是这里是empty string ， 空字符串）

SELECT @SQL = 
' UPDATE A ' +
' SET ' + 
CASE WHEN @YN_DIVISION_NAME = 'Y' THEN '   DIVISION_NAME = B.DIVISION_NAME, ' ELSE '' END +
CASE WHEN @YN_DIVISION_NUMBER = 'Y' THEN ' 	DIVISION_NUMBER = B.DIVISION_NUMBER, ' ELSE '' END +
CASE WHEN @YN_REGION_NAME = 'Y' THEN ' 	REGION_NAME = B.REGION_NAME, ' ELSE '' END +
CASE WHEN @YN_REGION_NUMBER = 'Y' THEN ' 	REGION_NUMBER = B.REGION_NUMBER, ' ELSE '' END +
CASE WHEN @YN_STATE_CODE = 'Y' THEN ' 	STATE_CODE = B.STATE_CODE, ' ELSE '' END +
CASE WHEN @YN_STATE_NAME = 'Y' THEN ' 	STATE_NAME = B.STATE_NAME ' ELSE '' END +
' FROM ' + @TBL + ' A INNER JOIN ' +
' 	 DIM_GEOGRAPHY_STATE B ' +
' 	   ON A.STATE_NUMBER = B.STATE_NUMBER ' 

---SELECT @sql文本

SELECT SQL_TEXT = @SQL

-- UPDATE A  SET    DIVISION_NAME = B.DIVISION_NAME,   DIVISION_NUMBER = B.DIVISION_NUMBER,   REGION_NAME = B.REGION_NAME,   REGION_NUMBER = B.REGION_NUMBER,   STATE_CODE = B.STATE_CODE,   STATE_NAME = B.STATE_NAME  FROM DIM_GEOGRAPHY_CENSUS_TRACT A INNER JOIN    DIM_GEOGRAPHY_STATE B      ON A.STATE_NUMBER = B.STATE_NUMBER 

---执行 @SQL 

EXEC (@SQL)

---FETCH 到下一个

FETCH C1 INTO @TBL, @YN_DIVISION_NAME, @YN_DIVISION_NUMBER, @YN_REGION_NAME,
		@YN_REGION_NUMBER, @YN_STATE_CODE, @YN_STATE_NAME 

---关闭 cursor C1

END
CLOSE C1
DEALLOCATE C1

END



'DIVISION_NAME', 'DIVISION_NUMBER', 'REGION_NAME', 'REGION_NUMBER', 'STATE_CODE', 'STATE_NAME'
DBA_NULL_COLUMNS
CNT_COLUMNS_IN_RECORDS
CNT_COLUMN_NOT_NULL






---创建store procedure
CREATE PROCEDURE P_UPDATE_COLUMNS
AS 
BEGIN 



--返回不计数
SET NOCCOUNT ON 


---DECLARE UPDATE VARIABLE STATEMMENT ,  变量表格， 当表格中包含columns的时候，进行更新
DECLARE @SQL VARCHAR(MAX),
        @TBL VARCHAR(100),
        @YN_DIVISION_NAME CHAR(1), 
        @YN_DIVISION_NUMBER CHAR(1), 
        @YN_REGION_NAME CHAR(1), 
        @YN_REGION_NUMBER CHAR(1),
        @YN_STATE_CODE CHAR(1), 
        @YN_STATE_NAME CHAR(1)

---DECLARE CURSOR FOR NOT_NULL_COLUMNS 表格，条件找到是null的列， 并且含有column STATE_NUMBER
DECLARE C1 CURSOR FOR 
SELECT TABLE_NAME ,
       YN_DIVISION_NAME=MAX(CASE WHEN COLUMN_NAME='DIVISION_NAME' THEN 'Y' ELSE 'N' END),
       YN_DIVSION_NUMBER=MAX(CASE WHEN COLUMN_NAME='DIVISION_NUMBER' THEN 'Y' ELSE 'N' END),
       YN_REGION_NAME=MAX(CASE WHEN COLUMN_NAME='REGION_NAME' THEN 'Y' ELSE 'N' END),
       YN_REGION_NUMBER=MAX(CASE WHEN COLUMN_NAME='REGION_NUMBER' THEN 'Y' ELSE 'N' END ),
       YN_STATE_CODE=MAX(CASE WHEN COLUMN_NAME='STATE_CODE' THEN 'Y' ELSE 'N' END ),
       YN_STATE_NAME=MAX(CASE WHEN COLUMN_NAME='STATE_NAME' THEN 'Y' ELSE 'N' END)
FROM DBA_NULL_COLUMNS A
WHERE CNT_COLUMNS_IN_RECORDS>0 AND 
      CNT_COLUMN_NOT_NULL=0 AND 
      COLUMN_NAME IN ('DIVISION_NAME', 'DIVISION_NUMBER', 'REGION_NAME', 'REGION_NUMBER', 'STATE_CODE', 'STATE_NAME') AND 
      EXSITS 
      (SELECT *
        FROM DBA_NULL_COLUMNS B 
          WHERE A.TABLE_NAME=B.TABLE_NAME AND 
                B.COLUMN_NAME='STATE_NUMBER' )
GROUP BY TABLE_NAME
 
---打开CURSOR 
OPEN C1 
FETCH C1 INTO @TBL ,@YN_DIVISION_NAME, @YN_DIVISION_NUMBER ,@YN_REGION_NAME, @YN_REGION_NUMBER ,@YN_STATE_CODE,@YN_STATE_NAME

-- 当 CURSOR条件成立的时候， 开始
WHILE @@FETCH_STATUS=0
BEGIN 
SELECT @SQL=
' UPDATE A ' +
' SET ' + 
CASE WHEN @YN_DIVISION_NAME='Y' THEN ' DIVSION_NAME=B.DIVISION_NAME ,' ELSE '' END +
CASE WHEN @DIVISION_NUMBER='Y' THEN ' DIVSION_NUMBER=B.DIVSION_NUMBER,' ELSE '' END +
CASE WHEN @REGION_NAME='Y' THEN ' REGION_NAME=B.REGION_NAME ,' ELSE '' END +
CASE WHEN @REGION_NUMBER='Y' THEN ' REGION_NUMBER=B.REGION_NUMBER ' ELSE '' END +
CASE WHEN @STATE_CODE='Y' THEN ' STATE_CODE=B.STATE_CODE ' ELSE '' END +
CASE WHEN @STATE_NAME='Y' THEN ' STATE_NAME=B.STATE_NAME ' ELSE '' END +
' FROM ' +
 @TBL + ' A INNER JOIN ' +
' DIM_GEOGRAPHY_STATE B ' +
' ON A.STATE_NUMBER=B.STATE_NUMBER '


---SELECT @sql文本
SELECT SQL_TEXT=@SQL 

 

-- 运行@SQL UPDATE from DIM_GEORAPHY_STATE
EXEC (@SQL)

---所有的变量 FETCH 到下一个
FETCH C1 INTO @TBL ,@YN_DIVISION_NAME, @YN_DIVISION_NUMBER ,@YN_REGION_NAME, @YN_REGION_NUMBER ,@YN_STATE_CODE,@YN_STATE_NAME


------关闭 cursor C1
END 
CLOSE C1 
DEALLOCATE C1 

END 










