CREATE PROCEDURE LOAD_DIM_CU_ITEM 
AS
BEGIN 

INSERT DIM_CU_ITEM
(DIM_CU_ITEM_CODE, ITEM_NAME , DISPLAY_LEVEL_NO, PARENT_DIM_CU_ITEM_CODE, 
 PARENT_ITEM_NAME, ITEM_SORT_SEQUENCE_no)
SELECT 
DIM_CU_ITEM_CODE=L.ITEM_CODE,
ITEM_NAME=L.ITEM_NAME,
DISPLAY_LEVEL_NO=L.DISPLAY_LEVEL,
PARENT_DIM_CU_ITEM_CODE=NULL, 
PARENT_ITEM_NAME=NULL,
ITEM_SORT_SEQUENCE_NO=L.SORT_SEQUENCE
--SELECT *
FROM LOAD_CU_ITEM L
WHERE NOT EXISTS
(SELECT *
FROM DIM_CU_ITEM D
WHERE D.DIM_CU_ITEM_CODE=L.ITEM_CODE )

UPDATE D
SET 
PARENT_DIM_CU_ITEM_CODE=D2.DIM_CU_ITEM_CODE ,
PARENT_ITEM_NAME=D2.ITEM_NAME
--select *
FROM DIM_CU_ITEM D,
     DIM_CU_ITEM D2
WHERE D2.DISPLAY_LEVEL_NO = D.DISPLAY_LEVEL_NO - 1 AND
      D2.ITEM_SORT_SEQUENCE_NO < D.ITEM_SORT_SEQUENCE_NO AND
	  NOT EXISTS 
	    (SELECT * 
		 FROM DIM_CU_ITEM D3
		 WHERE D3.DISPLAY_LEVEL_NO = D2.DISPLAY_LEVEL_NO AND 
		       D3.ITEM_SORT_SEQUENCE_NO < D.ITEM_SORT_SEQUENCE_NO AND 
			   D3.ITEM_SORT_SEQUENCE_NO > D2.ITEM_SORT_SEQUENCE_NO)
      


END 
