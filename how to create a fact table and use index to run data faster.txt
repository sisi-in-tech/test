ALTER PROCEDURE [dbo].[P_LOAD_FACT_CE_ALL_SERIES] 
AS 
BEGIN 
UPDATE F
SET YR=L.yr,
    MTH_period=L.period,
	VALUE=L.[       value],
	FOOTNOTE_CODE=L.footnote_codes--,
	
FROM FACT_CE_ALL_SERIES F, 
     LOAD_CE_AllCESSeries L,
	 DIM_TIME T
WHERE F.DIM_CE_SERIES_CODE=L.series_id AND
      F.DIM_TIME_ID = T.DIM_TIME_ID AND 
	  T.YR = L.YR AND
	  T.DIM_TIME_PERIOD_CODE = L.period
  

INSERT INTO FACT_CE_ALL_SERIES
(YR, MTH_PERIOD, VALUE, FOOTNOTE_CODE, DIM_CE_SERIES_CODE, DIM_CE_SUPERSECTOR_CODE,
DIM_CE_INDUSTRY_CODE, DIM_CE_EMPLOYMENT_METRIC_CODE,DIM_TIME_ID,YN_SEASONAL)
SELECT DISTINCT
	YR=L.yr,
	MTH_PERIOD=L.period,
	VALUE=L.[       value],
	FOOTNOT_CODE=L.footnote_codes,
	DIM_CE_SERIES_CODE=S.DIM_CE_SERIES_CODE,
	DIM_CE_SUPERSECTOR_CODE=S.DIM_CE_SUPERSECTOR_CODE,
	DIM_CE_INDUSTRY_CODE=S.DIM_CE_INDUSTRY_CODE, 
	DIM_CE_EMPLOYMENT_METRIC_CODE=S.DIM_CE_EMPLOYMENT_METRIC_CODE,
	DIM_TIME_ID=T.DIM_TIME_ID,
	YN_SEASONAL=
	CASE WHEN S.SEASONAL = 'S'  THEN 'Y'
	     WHEN S.SEASONAL = 'U' THEN 'N'
		 ELSE 'N'
	END 
FROM 
	LOAD_CE_AllCESSeries L INNER JOIN
	DIM_CE_SERIES S
	  ON S.DIM_CE_SERIES_CODE = L.[series_id        ] INNER JOIN
	DIM_TIME T 
	ON T.YR = L.YR AND
	   T.DIM_TIME_PERIOD_CODE = L.period
WHERE NOT EXISTS 
	(SELECT *
	 FROM FACT_CE_ALL_SERIES F  
	 WHERE F.DIM_CE_SERIES_CODE=L.series_id AND
	       F.DIM_TIME_ID = T.DIM_TIME_ID) 

/*****
DROP INDEX DIM_TIME.IX_DIM_TIME
CREATE INDEX IX_DIM_TIME
 ON DIM_TIME (YR, DIM_TIME_PERIOD_CODE) INCLUDE (DIM_TIME_ID)

CREATE CLUSTERED INDEX IX_LOAD_CE_AllCESSeries
 ON LOAD_CE_AllCESSeries (SERIES_ID, YR, period)
****/

END 

